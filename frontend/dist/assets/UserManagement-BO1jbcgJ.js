import{a as $}from"./api-CBBxTYRf.js";import{r as _,a as L,k as O,c as Z,f as r,g as z,i as b,w as o,e as l,b as I,l as h,F as T,j as q,d as x,h as g,_ as G,t as H,o as ee,E as M}from"./index-DBwGIS2Y.js";const le={style:{"text-align":"right"}},te={__name:"UserFormDrawer",props:{modelValue:{type:Boolean,default:!1},model:{type:Object,default:()=>({username:"",realName:"",department:"",status:"ACTIVE",roles:[]})},roleOptions:{type:Array,default:()=>[]}},emits:["update:modelValue","submit"],setup(E,{emit:w}){const d=E,C=w,i=_(!1),c=_(!1),V={id:null,username:"",realName:"",department:"",status:"ACTIVE",roles:[],password:"",confirmPassword:""},e=L({...V}),m=_(),P={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],realName:[{required:!0,message:"请输入姓名",trigger:"blur"}],password:[{validator:(v,t,f)=>{if(e.id){f();return}if(!t||t.length<8){f(new Error("密码至少 8 位"));return}if(t!==e.confirmPassword){f(new Error("两次密码不一致"));return}f()},trigger:"blur"}],confirmPassword:[{validator:(v,t,f)=>{if(e.id){f();return}if(t!==e.password){f(new Error("两次密码不一致"));return}f()},trigger:"blur"}],roles:[{required:!0,message:"请至少选择一个角色",trigger:"change"}]};O(()=>d.modelValue,v=>{var t;i.value=v,v&&(Object.assign(e,V,d.model??{}),e.roles=Array.isArray((t=d.model)==null?void 0:t.roles)?[...d.model.roles]:[],e.password="",e.confirmPassword="")}),O(i,v=>{C("update:modelValue",v)});const N=Z(()=>e.id?"编辑用户":"创建用户"),p=()=>{m.value.validate(async v=>{if(v){c.value=!0;try{const t={id:e.id,username:e.username,realName:e.realName,department:e.department,status:e.status,roles:[...e.roles]};e.id||(t.password=e.password),C("submit",t),i.value=!1,Object.assign(e,V)}finally{c.value=!1}}})};return(v,t)=>{const f=r("el-input"),y=r("el-form-item"),D=r("el-option"),B=r("el-select"),s=r("el-form"),a=r("el-button"),F=r("el-drawer");return b(),z(F,{modelValue:i.value,"onUpdate:modelValue":t[8]||(t[8]=n=>i.value=n),title:N.value,size:"40%","destroy-on-close":""},{footer:o(()=>[x("div",le,[l(a,{onClick:t[7]||(t[7]=n=>i.value=!1)},{default:o(()=>[...t[9]||(t[9]=[g("取消",-1)])]),_:1}),l(a,{type:"primary",onClick:p,loading:c.value},{default:o(()=>[...t[10]||(t[10]=[g("保存",-1)])]),_:1},8,["loading"])])]),default:o(()=>[l(s,{model:e,rules:P,ref_key:"formRef",ref:m,"label-width":"96px"},{default:o(()=>[l(y,{label:"用户名",prop:"username"},{default:o(()=>[l(f,{modelValue:e.username,"onUpdate:modelValue":t[0]||(t[0]=n=>e.username=n),disabled:!!e.id},null,8,["modelValue","disabled"])]),_:1}),l(y,{label:"姓名",prop:"realName"},{default:o(()=>[l(f,{modelValue:e.realName,"onUpdate:modelValue":t[1]||(t[1]=n=>e.realName=n)},null,8,["modelValue"])]),_:1}),l(y,{label:"部门",prop:"department"},{default:o(()=>[l(f,{modelValue:e.department,"onUpdate:modelValue":t[2]||(t[2]=n=>e.department=n)},null,8,["modelValue"])]),_:1}),e.id?h("",!0):(b(),I(T,{key:0},[l(y,{label:"初始密码",prop:"password"},{default:o(()=>[l(f,{modelValue:e.password,"onUpdate:modelValue":t[3]||(t[3]=n=>e.password=n),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),l(y,{label:"确认密码",prop:"confirmPassword"},{default:o(()=>[l(f,{modelValue:e.confirmPassword,"onUpdate:modelValue":t[4]||(t[4]=n=>e.confirmPassword=n),type:"password","show-password":""},null,8,["modelValue"])]),_:1})],64)),l(y,{label:"角色",prop:"roles"},{default:o(()=>[l(B,{modelValue:e.roles,"onUpdate:modelValue":t[5]||(t[5]=n=>e.roles=n),multiple:"",placeholder:"请选择角色"},{default:o(()=>[(b(!0),I(T,null,q(E.roleOptions,n=>(b(),z(D,{key:n.code,label:n.name??n.code,value:n.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(y,{label:"状态",prop:"status"},{default:o(()=>[l(B,{modelValue:e.status,"onUpdate:modelValue":t[6]||(t[6]=n=>e.status=n)},{default:o(()=>[l(D,{label:"启用",value:"ACTIVE"}),l(D,{label:"禁用",value:"DISABLED"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}},ae={style:{"text-align":"right"}},oe={__name:"RoleAssignmentDrawer",props:{modelValue:{type:Boolean,default:!1},roles:{type:Array,default:()=>[]},value:{type:Array,default:()=>[]}},emits:["update:modelValue","change"],setup(E,{emit:w}){const d=E,C=w,i=_(!1),c=_([]);O(()=>d.modelValue,e=>{i.value=e,e&&(c.value=[...d.value])}),O(i,e=>C("update:modelValue",e));const V=()=>{C("change",c.value),i.value=!1};return(e,m)=>{const k=r("el-checkbox"),S=r("el-checkbox-group"),P=r("el-button"),N=r("el-drawer");return b(),z(N,{modelValue:i.value,"onUpdate:modelValue":m[2]||(m[2]=p=>i.value=p),title:"角色分配",size:"30%","destroy-on-close":""},{footer:o(()=>[x("div",ae,[l(P,{onClick:m[1]||(m[1]=p=>i.value=!1)},{default:o(()=>[...m[3]||(m[3]=[g("取消",-1)])]),_:1}),l(P,{type:"primary",onClick:V},{default:o(()=>[...m[4]||(m[4]=[g("保存",-1)])]),_:1})])]),default:o(()=>[l(S,{modelValue:c.value,"onUpdate:modelValue":m[0]||(m[0]=p=>c.value=p),class:"role-list"},{default:o(()=>[(b(!0),I(T,null,q(E.roles,p=>(b(),z(k,{key:p.code,label:p.code},{default:o(()=>[g(H(p.name),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])}}},se=G(oe,[["__scopeId","data-v-b97fb457"]]),ne={class:"page-header flex-between"},re={class:"card-section"},ue={class:"filters"},de={class:"pagination"},ie={__name:"UserManagement",setup(E){const w=L({keyword:"",status:"ALL"}),d=L({page:1,pageSize:20,total:0}),C=_([]),i=_(!1),c=_(!1),V=_(!1),e=_(null),m=_([]),k=_([]),S=L({}),P=s=>{s.forEach(a=>{S[a.code]=a.name})},N=async()=>{k.value=await $.listRoles(),P(k.value)},p=async()=>{i.value=!0;try{const s=await $.listAdminUsers({...w,page:d.page,pageSize:d.pageSize});C.value=s.items,d.total=s.total,d.page=s.page,d.pageSize=s.pageSize}finally{i.value=!1}};ee(async()=>{await Promise.all([N(),p()])});const v=s=>{e.value=s?{...s}:null,c.value=!0},t=async s=>{await $.saveAdminUser(s),M.success("用户信息已保存"),p()},f=s=>{e.value=s,m.value=[...s.roles??[]],V.value=!0},y=async s=>{e.value&&(await $.assignRoles(e.value.id,s),M.success("角色已更新"),V.value=!1,p())},D=async(s,a)=>{await $.updateUserStatus(s,a),M.success("状态已更新")},B=s=>{d.page=s,p()};return(s,a)=>{const F=r("User"),n=r("el-icon"),R=r("el-button"),J=r("el-input"),j=r("el-option"),K=r("el-select"),A=r("el-table-column"),Q=r("el-tag"),W=r("el-switch"),X=r("el-table"),Y=r("el-pagination");return b(),I("div",null,[x("div",ne,[a[7]||(a[7]=x("h2",null,"用户管理",-1)),l(R,{type:"primary",onClick:a[0]||(a[0]=u=>v())},{default:o(()=>[l(n,null,{default:o(()=>[l(F)]),_:1}),a[6]||(a[6]=g(" 新建用户 ",-1))]),_:1})]),x("section",re,[x("div",ue,[l(J,{modelValue:w.keyword,"onUpdate:modelValue":a[1]||(a[1]=u=>w.keyword=u),placeholder:"搜索用户名/姓名",style:{width:"240px"},clearable:""},null,8,["modelValue"]),l(K,{modelValue:w.status,"onUpdate:modelValue":a[2]||(a[2]=u=>w.status=u),placeholder:"状态",style:{width:"160px"}},{default:o(()=>[l(j,{label:"全部",value:"ALL"}),l(j,{label:"启用",value:"ACTIVE"}),l(j,{label:"禁用",value:"DISABLED"})]),_:1},8,["modelValue"]),l(R,{type:"primary",onClick:p,loading:i.value},{default:o(()=>[...a[8]||(a[8]=[g("查询",-1)])]),_:1},8,["loading"])]),l(X,{data:C.value,border:"",stripe:""},{default:o(()=>[l(A,{prop:"username",label:"用户名",width:"140"}),l(A,{prop:"realName",label:"姓名",width:"120"}),l(A,{prop:"department",label:"部门"}),l(A,{label:"角色"},{default:o(({row:u})=>[(b(!0),I(T,null,q(u.roles,U=>(b(),z(Q,{key:`${u.id}-${U}`,style:{"margin-right":"6px"}},{default:o(()=>[g(H(S[U]??U),1)]),_:2},1024))),128))]),_:1}),l(A,{label:"状态",width:"120"},{default:o(({row:u})=>[l(W,{modelValue:u.status,"onUpdate:modelValue":U=>u.status=U,"active-value":"ACTIVE","inactive-value":"DISABLED",onChange:U=>D(u.id,U)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(A,{prop:"createdAt",label:"创建时间",width:"140"}),l(A,{label:"操作",width:"220"},{default:o(({row:u})=>[l(R,{link:"",type:"primary",onClick:U=>v(u)},{default:o(()=>[...a[9]||(a[9]=[g("编辑",-1)])]),_:1},8,["onClick"]),l(R,{link:"",type:"success",onClick:U=>f(u)},{default:o(()=>[...a[10]||(a[10]=[g("分配角色",-1)])]),_:1},8,["onClick"]),l(R,{link:"",type:"danger"},{default:o(()=>[...a[11]||(a[11]=[g("重置密码",-1)])]),_:1})]),_:1})]),_:1},8,["data"]),x("div",de,[l(Y,{layout:"total, prev, pager, next",total:d.total,"page-size":d.pageSize,"current-page":d.page,"onUpdate:currentPage":a[3]||(a[3]=u=>d.page=u),onCurrentChange:B},null,8,["total","page-size","current-page"])])]),l(te,{modelValue:c.value,"onUpdate:modelValue":a[4]||(a[4]=u=>c.value=u),model:e.value,"role-options":k.value,onSubmit:t},null,8,["modelValue","model","role-options"]),l(se,{modelValue:V.value,"onUpdate:modelValue":a[5]||(a[5]=u=>V.value=u),value:m.value,roles:k.value,onChange:y},null,8,["modelValue","value","roles"])])}}},fe=G(ie,[["__scopeId","data-v-e6a42bec"]]);export{fe as default};

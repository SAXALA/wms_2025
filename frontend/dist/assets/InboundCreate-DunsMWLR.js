import{a as I}from"./api-CBBxTYRf.js";import{_ as R,r as v,a as T,o as A,c as G,b,d as u,e as t,w as s,f as i,g as y,l as H,i as c,h as V,F as U,j as w,t as J,E as p}from"./index-DBwGIS2Y.js";const O={class:"page-header flex-between"},W={class:"card-section"},X={class:"form-header"},Y={class:"card-section"},Z={class:"add-line-panel"},ee={class:"card-section"},le={class:"location-cell"},te={key:1,class:"text-muted"},ne={__name:"InboundCreate",setup(ae){const k=v(!1),g=v([]),N=v([]),f=v(null),r=v(1),m=v(null),o=T({reference:"",expectedDate:"",lines:[]});A(async()=>{g.value=await I.listProducts(),N.value=await I.listLocations({includeInactive:!1})});const L=G(()=>N.value.filter(n=>n.active)),q=n=>L.value.find(e=>String(e.id)===String(n)),D=(n,e)=>{const a=q(e);if(!a){n.locationId=null,n.locationLabel="";return}n.locationId=a.id,n.locationLabel=a.displayLabel},P=()=>{if(!f.value){p.warning("请选择商品");return}const n=g.value.find(a=>a.id===f.value);if(!n){p.error("商品不存在");return}if(!r.value||r.value<=0){p.error("数量必须大于 0");return}const e=o.lines.find(a=>a.productId===n.id);if(e)e.quantity+=Number(r.value),m.value&&D(e,m.value);else{const a=q(m.value);o.lines.push({productId:n.id,sku:n.sku,name:n.name,unit:n.unit,quantity:Number(r.value),locationId:(a==null?void 0:a.id)??null,locationLabel:(a==null?void 0:a.displayLabel)??""})}p.success("已加入入库清单"),f.value=null,r.value=1,m.value=null},E=n=>{o.lines.splice(n,1)},$=async()=>{if(!o.lines.length){p.error("请至少添加一行物料");return}if(o.lines.find(e=>!e.productId||e.quantity<=0)){p.error("请确保所有物料的商品与数量有效");return}k.value=!0;try{await I.submitInbound({...o}),p.success("入库申请已提交"),o.reference="",o.expectedDate="",o.lines=[]}finally{k.value=!1}};return(n,e)=>{const a=i("CircleCheck"),S=i("el-icon"),h=i("el-button"),F=i("el-input"),M=i("el-date-picker"),x=i("el-option"),C=i("el-select"),B=i("el-input-number"),j=i("Plus"),_=i("el-table-column"),z=i("el-tag"),K=i("el-table"),Q=i("el-empty");return c(),b("div",null,[u("div",O,[e[6]||(e[6]=u("h2",null,"入库申请创建",-1)),t(h,{type:"primary",loading:k.value,onClick:$},{default:s(()=>[t(S,null,{default:s(()=>[t(a)]),_:1}),e[5]||(e[5]=V(" 提交入库单 ",-1))]),_:1},8,["loading"])]),u("section",W,[u("div",X,[t(F,{modelValue:o.reference,"onUpdate:modelValue":e[0]||(e[0]=l=>o.reference=l),placeholder:"关联单号 / 备注",style:{width:"320px"}},null,8,["modelValue"]),t(M,{modelValue:o.expectedDate,"onUpdate:modelValue":e[1]||(e[1]=l=>o.expectedDate=l),type:"date",placeholder:"计划入库日期"},null,8,["modelValue"])])]),u("section",Y,[e[8]||(e[8]=u("h3",{class:"section-title"},"选择物料",-1)),u("div",Z,[t(C,{modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=l=>f.value=l),filterable:"",placeholder:"请选择商品",style:{width:"320px"}},{default:s(()=>[(c(!0),b(U,null,w(g.value,l=>(c(),y(x,{key:l.id,label:`${l.name} (${l.sku})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(B,{modelValue:r.value,"onUpdate:modelValue":e[3]||(e[3]=l=>r.value=l),min:1,step:10,placeholder:"数量"},null,8,["modelValue"]),t(C,{modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=l=>m.value=l),placeholder:"选择库位 (可选)",style:{width:"220px"},clearable:"",filterable:""},{default:s(()=>[(c(!0),b(U,null,w(L.value,l=>(c(),y(x,{key:l.id,label:l.displayLabel,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(h,{type:"primary",link:"",onClick:P},{default:s(()=>[t(S,null,{default:s(()=>[t(j)]),_:1}),e[7]||(e[7]=V(" 加入清单 ",-1))]),_:1})])]),u("section",ee,[e[10]||(e[10]=u("h3",{class:"section-title"},"入库明细",-1)),t(K,{data:o.lines,border:""},{default:s(()=>[t(_,{prop:"sku",label:"SKU",width:"140"}),t(_,{prop:"name",label:"物料名称"}),t(_,{prop:"unit",label:"单位",width:"80"}),t(_,{label:"数量",width:"140"},{default:s(({row:l})=>[t(B,{modelValue:l.quantity,"onUpdate:modelValue":d=>l.quantity=d,min:1},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),t(_,{label:"库位",width:"220"},{default:s(({row:l})=>[u("div",le,[t(C,{modelValue:l.locationId,"onUpdate:modelValue":d=>l.locationId=d,placeholder:"选择库位",filterable:"",clearable:"",onChange:d=>D(l,d)},{default:s(()=>[(c(!0),b(U,null,w(L.value,d=>(c(),y(x,{key:d.id,label:d.displayLabel,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),l.locationLabel?(c(),y(z,{key:0,size:"small",type:"info"},{default:s(()=>[V(J(l.locationLabel),1)]),_:2},1024)):(c(),b("span",te,"未指定"))])]),_:1}),t(_,{label:"操作",width:"100"},{default:s(({$index:l})=>[t(h,{link:"",type:"danger",onClick:d=>E(l)},{default:s(()=>[...e[9]||(e[9]=[V("移除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),o.lines.length?H("",!0):(c(),y(Q,{key:0,description:"请选择商品加入清单"}))])])}}},ie=R(ne,[["__scopeId","data-v-2d29e9c2"]]);export{ie as default};
